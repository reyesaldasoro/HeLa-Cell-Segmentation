<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>Tracking Neutrophils with Matlab</title>
      <meta name="generator" content="MATLAB 7.4">
      <meta name="date" content="2010-08-23">
      <meta name="m-file" content="trackingManual"><style>

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
    font-size: medium;
          font-size: medium;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
    font-size: medium;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">


<br>
 <a href="shortcuts.php"      > Previous (Shortcuts Matlab)   </a>
/ <a href="namaste.php"          > Index                          </a>
/ <a href="trackingManual2.php" > Next (Tracking Neutrophils with Matlab 2)   </a>  
<br>



         <h1>Tracking Neutrophils with Matlab 1</h1>
         <introduction>
            <p>To track neutrophils, Matlab requires a series of functions and routines that in some cases call other functions or subfunctions.
               The  data input should be a directory where you should have a series of directories (one for each time frame) with tiff files,
               one for each slice of the data. This is format how volocity exports the data. So before using Matlab you need to export the
               data from volocity.
            </p>
         </introduction>
         <h2>Contents</h2>

            <ul>
               <li><a href="#1">Input and Output Folders</a></li>
               <li><a href="#2">Different Starting Points</a></li>
               <li><a href="#5">Start the tracking</a></li>
               <li><a href="#9">Assessing the threshold levels</a></li>
            </ul>

         <h2>Input and Output Folders<a name="1"></a></h2>
         <p>It is important to keep names simple, as the tracking will create several folders related to the original folder, try to avoid
            spaces and special characters such as &amp;, ^, %, &amp;, +, etc. It is better use only a to z, A to Z and numbers. So, if you have a folder
            with the name "images", the following folders will be created:
         </p>
         <FONT     padding="10px"   size="medium" style="BACKGROUND-COLOR: #EEEEEE">
         <ul>
             <li>% example of the output directories :         images_mat_Or    &lt;- original data in matlab format
                 <li>% example of the output directories :         images_mat_Re    &lt;- data reduced in size
                     <li>% example of the output directories :         images_mat_La    &lt;- labelled data
                         <li>% example of the output directories :         images_mat_Ha    &lt;- Handles, this folder holds the results
             
             
         </ul>
         
         
         </FONT>
         <p>The first step will read the data from the TIFF files and transform it to Matlab, the function "readNeutrophils"  will then
            in turn write on a new root folder a series of directories with the data in matlab format.
         </p>
         <p>Then, to reduce computational complexity by averaging neighbouring pixels in a uniform pyramid, 2 levels would reduce from
            1000x1000 to 250x250 reduceNeutrophils will read the folder and then iteratively reduce size in each frame and save setNeutrophilHandles
            determines the dimensions of the data set and the <b>*thresholds</b>* used to segment "reduceNeutrophil" will threshold and label the neutrophils. To increase the accuracy for the segmentation
            a double thresholding is performed, small blobs are removed as noise.
         </p>
         <p>All this pre-processing is required to perform the tracking with the function "trackNeutrophil" The final data is stored inside
            handles, handles.finalNetwork and handles.nodeNetwork have all the data, handles.nodeNetwork has the following structure:
         </p>

         <FONT  padding="10px"  size="medium" style="BACKGROUND-COLOR: #EEEEEE">
%[    X   Y   Z  distancetoNext  timeFrame     ID  Parent  Child   -   Volume  Label  KeyholeRegion  Track   FinalLabel  BoundingBox(X init  Y init  Z init  X   Y   Z)  ]
</font>

         <br/>
         <br/>
         
         
                  <h2>Different Starting Points<a name="2"></a></h2>
         <p>The algorithms can start from different data inputs. That is, you can start processing the 
            neutrophil data from the images that you will receive as an output of the acquisition system, but
            once you have transformed these images into MATLAB, you do not need to read them again, you can select 
            as your input any folder, if you want to change the levels to reduce, then select the folder <b>images_mat_Or</b>,
            if you are happy with the reduced data and you want to change threshold levels, you can select the folder 
            <b>images_mat_Re</b>, if you want to track over the data that has been segmented labelled you can select <b>images_mat_La</b>. 
             
         </p>

         
  
         <br/>
         <br/>       
         
         
         <h2>Start the tracking<a name="5"></a></h2>

         <p>The syntax of the matlab command for the tracking is:</p>


<FONT   padding="10px" style="BACKGROUND-COLOR: #EEEEEE">
[handles]= neutrophilAnalysis(dataInName,numLevelsToReduce);
</font>
         <br/>
         <br/>

<p>dataInName : is the name of the folder where the subfolders where the tiff files are located, you can either pass this name
            or select it later. numLevelsToReduce : this controls the reduction of the data, the default value is 2 that will reduce the
            images from 1000 x 1000 to 250 x 250. handles keeps the results.
         </p>

         <p>So, to process a folder called "NeutropTest" (which contains 9 folders with tiff files) the easiest way to analyse it is to call the function with no parameters:</p>
<pre class="codeinput">
[handles]= neutrophilAnalysis();
</pre><p class="footer">



<p>This will open a window from which a folder can be selected:</p>
<br>


<img vspace="5" hspace="5" src="Figure5.png"> 
<br><br>

<p>So, for example, to open the folder "NeutropTest" you should navigate to the corresponding folder:</p>
<br />
<img vspace="5" hspace="5" src="Figure6.png"> 
<br /><br />

<p>Once you select the folder, the processing will start and as the data is processed this will appear in the command window:
</p>


<pre class="codeoutput">
Read tiff images from folders and save as matlab data
Read matlab files from folder, reduce and save in a new folder *_mat_Re

</pre>

<p>
            
           The data will now be saved in one file (<i>T00001.mat, T00002.mat, T00003.mat</i>, ... inside the _mat_Re folder) 
           for each time frame. The file contains the 3D structure corresponding to all the images of the frame. 
           These slices can be of fluorescent or DIC channels, so the algorithm will now open a new window to determine the structure. 
           The algorithm will count the number of images (or slices or levels) and then try to distinguish between DIC and fluorescent. 
           DIC will spread the intensity in the middle of the range, whilst fluorescent will concentrate in the low levels (to the left). 
           For instance, a case of 6 levels, 3 green fluorescent and 3 DIC will look like this: 
            
</p>

<br />
<img vspace="5" hspace="5" src="images/GreenDICChannels.png"> 
<br /><br />

<p>
    While a case of 40 Green and Re channels would look like this:
    
</p>
<br />
<img vspace="5" hspace="5" src="images/RedGreenChannels.png"> 
<br /><br />
<p>
    The algorithm cannot distinguish between Green and Red Channels, so it will assume that all fluorescence is green, 
    so you need to correct this manually in the appropriate window. <br />
Once you have selected the correct distribution of the levels, the algorithm will continue:

    
    
</p>
         <h2>Assessing the threshold levels<a name="9"></a></h2>

          <p>Immediately after selecting the appropriate levels for the fluorescence and DIC, the threshold levels are automatically selected. In some cases, these levels need to be manually verified. This is done with the first time point of the data.</p><!--/introduction-->

          <p>The algorithms will select the low and high thresholds and a group of windows will be opened to display:</p><p>(1) The maximum intensity projection (the highest value each pixel(row,column) can have for each slice down the Z-stack) and the pixels of this projection that are above the two thresholds. The region of highest intensity (strongest fluorescence) will be selected to zoom in.</p>
          <p>(2) A detailed region where the highest intensity is located, and</p><p>(3) A 3D plot of the neutrophils in that region. A red surface will indicate the low threshold and the blue surface will indicate the high threshold. This plot is three-dimensional and you can rotate it to find the best view for the neutrophils in question.</p>
          <h2>Modifying values</h2>
          <p>If you want to change the region to plot (and thus analyse some interesting neutrophils, two that are very close to each other for instance), or you want to modify the thresholds, you can do that at this moment through the command line, where you will be asked if you want to change something. If you do not want any changes, just press enter. Otherwise, type 'y' and enter. Then you will be prompted for the region to plot (initial Row, final Row, initial Column, final Column) and the thresholds. If you do not want to change any of them, press enter, otherwise, type the new value and press enter.</p>

          <br />
                <img vspace="5" hspace="0" width="650" src="images/verifyThresholds1.jpg"> 
          <br />
                <img vspace="5" hspace="0"  width="650" src="images/verifyThresholds2.jpg"> 
          <br />
                <img vspace="5" hspace="0"  width="400" src="images/verifyThresholds3.jpg"> 
          <br /><br />



          <pre class="codeinput">
Do you want modify plot or threshold levels? Y/N [n]: y
          </pre>
          <p>After typing 'y' and return you are prompted to change parameters. It looks like there are two neutrophils very close to
          each other around the region of [210-260] in the rows and [510-570] in the columns (that is to the right of the zoom region).
          Thus those parameters are changed:</p>

          <pre class="codeinput">
Type the new values for the following parameter or press RETURN to leave unchanged
Low threshold =512.6471;800
High threshold =756.2059;1200
Initial row to plot = [210];
Final row to plot = [260];
Initial column to plot = [510];
Final column to plot = [570];
          </pre>
           <br />
                <img vspace="5" hspace="0" width="650" src="images/verifyThresholds4.jpg"> 
          <br />
                <img vspace="5" hspace="0" width="650" src="images/verifyThresholds5.jpg"> 
          <br />
                <img vspace="5" hspace="0" width="400" src="images/verifyThresholds6.jpg"> 
          <br />
                <img vspace="5" hspace="0" width="400" src="images/verifyThresholds7.jpg"> 
          <br /><br />
             
          <p>Now it is time to modify the thresholds. It looks like the neutrophils are merged into one single cell at both thresholds, 
          therefore, let's try with higher levels, say 880 and 1100 (you may need to go through several iterations to find the optimal thresholds): </p>        
              <pre class="codeinput">
Type the new values for the following parameter or press RETURN to leave unchanged
Low threshold =512.6471;880
High threshold =756.2059;1100
Initial row to plot = [210];
Final row to plot = [260];
Initial column to plot = [510];
Final column to plot = [570];
          </pre>
          <p>Notice that all other parameters remain the same.</p>

                    <br />
                <img vspace="5" hspace="0" width="500" src="images/verifyThresholds8.jpg"> 

                    <p>Now that the neutrophils appear separate from each other, the process can continue. Just press enter at the prompt
                    to keep the same values and continue with the process:</p>


<pre class="codeoutput">
Read reduced matlab data, Threshold, Label and save in a new folder *_mat_La
Split Large Neutrophils and re-save in same folder  *_mat_La
Initial Tracking process
Keep the disappearing cells and re-save in the same folder *_mat_La
Second Tracking process
Split merged cells and re-save in a the same folder _mat_La
Final Tracking process
</pre>


<br>
 <a href="shortcuts.php"      > Previous (Shortcuts Matlab)   </a>
/ <a href="namaste.php"          > Index                          </a>
/ <a href="trackingManual2.php" > Next (Tracking Neutrophils with Matlab 2)   </a>
  
<br>



<p class="footer">
<br>
            Published with MATLAB&reg; 7.4<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####

%% Tracking Neutrophils with Matlab
% To track neutrophils, Matlab requires a series of functions and routines that in some cases call other
% functions or subfunctions. 
% The  data input should be a directory where you should have a series of directories (one for each time
% frame) with tiff files, one for each slice of the data. This is format how volocity exports the data. So before using Matlab you need to export the data from volocity.  

%% Input and Output Folders
% It is important to keep names simple, as the tracking will create several folders related to the
% original folder, try to avoid spaces and special characters such as &, ^, %, &, +, etc. It is better
% use only a to z, A to Z and numbers.

% example of an input directory     :         images
% example of the output directories :         images_mat_Or    <- original data in matlab format
% example of the output directories :         images_mat_Re    <- data reduced in size 
% example of the output directories :         images_mat_La    <- labelled data 
% example of the output directories :         images_mat_Ha    <- Handles, this folder holds the results

%%
% The first step will read the data from the TIFF files and transform it to Matlab, the function
% "readNeutrophils"  will then in turn write on a new root folder a series of directories with the data in matlab format.

%%
% Then, to reduce computational complexity by averaging neighbouring pixels in a uniform pyramid, 2 levels would reduce from 1000x1000 to 250x250 reduceNeutrophils will read the folder and then iteratively reduce size in each frame and save
% setNeutrophilHandles determines the dimensions of the data set and the **thresholds** used to segment
% "reduceNeutrophil" will threshold and label the neutrophils. To increase the accuracy for the segmentation a double thresholding is performed, small blobs are removed as noise.
%%
% All this pre-processing is required to perform the tracking with the function "trackNeutrophil"
% The final data is stored inside handles, handles.finalNetwork and handles.nodeNetwork have all the data, handles.nodeNetwork has the following structure:

%[    X   Y   Z  distancetoNext  timeFrame     ID  Parent  Child   -   Volume  Label  KeyholeRegion  Track   FinalLabel  BoundingBox(X init  Y init  Z init  X   Y   Z)  ]

%% Start the tracking
% The syntax of the matlab command for the tracking is:
%[handles]= preProcessingNeutrophils(dataInName,numLevelsToReduce);

%% 
% dataInName : is the name of the folder where the subfolders where the tiff files are located, you can
% either pass this name or select it later.
% numLevelsToReduce : this controls the reduction of the data, the default value is 2 that will reduce the images from
% 1000 x 1000 to 250 x 250. 
% handles keeps the results.

%%
% So, to process a folder called "NeutropTest"  the easiest way to analyse it is to call the function with
% no parameters:


[handles]= preProcessingNeutrophils();



##### SOURCE END #####
-->



   </body>
</html>